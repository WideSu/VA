---
title: "Take Home Exercise 3"
author:
- name: "Huang Anni"
  affiliation: "Singapore Management University"
description: |
  VAST Challenge 3
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
---

# The task
With reference to Challenge 3 of VAST Challenge 2022, you are required to reveal the economic of the city of Engagement, Ohio USA by using appropriate static and interactive statistical graphics methods


```{r setup, include=FALSE}
#devtools::install_github("rstudio/crosstalk")
#devtools::install_github("jcheng5/d3scatter")
#devtools::install_github("rstudio/leaflet")

knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      warning = FALSE, 
                      message = FALSE)
```

# Introduction
  
This exercise requires us to apply the skills you had learned in Lesson 1 and Hands-on Exercise 1 to reveal the demographic of the city of Engagement, Ohio USA by using appropriate static statistical graphics methods. The data should be processed by using appropriate tidyverse family of packages and the statistical graphics must be prepared using ggplot2 and its extensions.
![image](https://user-images.githubusercontent.com/44923423/166912984-6b798c62-f22e-4566-ac08-ad74e02af498.png)

  
```{r include=FALSE}
packages = c('ggiraph', 'plotly', 'tidyverse', 'DT','gganimate',
             'knitr', 'ggdist', 'scales', 'grid', 'gridExtra',
             'patchwork','ggsignif','gghighlight',"hrbrthemes",
             'readxl', 'gifski', 'gapminder','treemap', 'treemapify',
             'rPackedBar','ggridges','rmarkdown','crosstalk','d3scatter','tidycensus')

for(p in packages) {
  if(!require(p, character.only = T)) {
    install.packages(p)
  }
  library(p, character.only = T)
}
```

```{r load data, include=TRUE, preview=TRUE}
financial <- read_csv('./data/FinancialJournal.csv')
participant_data <- read_csv('./data/Participants.csv')
financial$new_tms <- as.POSIXct(financial$timestamp, format="%Y-%m-%d %H:%M:%S")
financial$year <- format(financial$new_tms, format="%Y")
financial$month <- format(financial$new_tms, format="%m")
financial$hour <- format(financial$new_tms, format="%H")
spending_per_month <- financial %>% 
  group_by(month,category) %>%
  filter(!category %in% c('Wage', 'RentAdjustment')) %>%
  summarise(mean_amount = - mean(amount)) 
p1 <- ggplot(data=spending_per_month, aes(x=month,
                                          y= mean_amount,
                                          fill=category,
                                          group=category,
                                          text = paste('</br>Month: ', month,
                      '</br>Mean spending: ', mean_amount,
                      '</br>Category: ', category))) +
  geom_point() +
  geom_line()+
    #geom_bar(position="dodge2", stat = "identity") +
  facet_grid(category~. , scales = "free_y")
  labs(y= 'Mean', x= 'Month',
       title = "Fig1: Average spending per month by category",
       subtitle = "Most peopl")
ggplotly(p1,
         tooltip = "text",
         hovermode = "closest",
         showspikes = TRUE)

```

```{r}
#> `summarise()` ungrouping output (override with `.groups` argument)
fig <- plot_ly(financial, type = 'scatter', mode = 'lines')%>%
  add_trace(x = ~new_tms, y = ~amount, color= ~category)%>%
  layout(showlegend = F, title='Time Series with Rangeslider',
         xaxis = list(rangeslider = list(visible = T)))
fig <- fig %>%
  layout(
         xaxis = list(zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         yaxis = list(zerolinecolor = '#ffff',
                      zerolinewidth = 2,
                      gridcolor = 'ffff'),
         plot_bgcolor='#e5ecf6', width = 900)

fig
```

# Data Processing
Our data includes two csv files from the VAST data source, namely FinancialJournal.csv and Participants.csv. To show the financial health of Ohio city, we derived three supporting tables from the original data. Generally, we want to ananlyze the **spending habits** and **wage status** of people with **different education background, age, and household size**.

## The overview of income, spending, and remaining per month

- month_finance_status: the **mean income, spending, and remaining of each month** for all the participants.

```{r data processing 1, include=TRUE, preview=TRUE}
monthly_income <- financial %>%
  filter(category %in% c('Wage', 'RentAdjustment')) %>%
  group_by(year, month) %>%
  summarise(income = mean(amount))
monthly_spend <- financial %>%
  filter(!category %in% c('Wage', 'RentAdjustment')) %>%
  group_by(year, month) %>%
  summarise(spend = mean(abs(amount)))
monthly_finance_status <- merge(monthly_income,monthly_spend,by=c("year","month"))
monthly_finance_status$date <- paste(monthly_finance_status$year, monthly_finance_status$month, sep='-')
monthly_finance_status$spendRatio <- monthly_finance_status$spend / monthly_finance_status$income
monthly_finance_status$remain <- (monthly_finance_status$income - monthly_finance_status$spend)
monthly_finance_status$remain <- round(monthly_finance_status$remain, 1)
```

## What is affecting the wage?

- participant_finance: we grouped people into 5 wage groups, which are '<=100', '101-200', '201-300', '301-400', '>400' to analyse their spending habits separately.

```{r data processing 2, include=TRUE, preview=TRUE}
wage <- financial %>%
  filter(category == "Wage") %>%
  group_by(participantId) %>%
  summarise(wage = mean(amount))
brks <- c(0, 100, 200, 300, 400, Inf)
grps <- c('<=100', '101-200', '201-300', '301-400', '>400')
wage$Wage_Group <- cut(wage$wage, breaks=brks, labels = grps, right = FALSE)
wage <- financial %>%
  filter(category == 'Wage') %>%
  group_by(participantId) %>%
  summarise(wage = mean(amount))
brks <- c(0, 100, 200, 300, 400, Inf)
grps <- c('<=100', '101-200', '201-300', '301-400', '>400')
wage$Wage_Group <- cut(wage$wage, breaks=brks, labels = grps, right = FALSE)
#glimpse(wage)
```

## What are the spending habits of different people?

Participants's wage and personal information.

```{r data processing, include=TRUE, preview=TRUE}
wage <- financial %>%
  filter(category == "Wage") %>%
  group_by(participantId) %>%
  summarise(wage = mean(amount))
brks <- c(0, 100, 200, 300, 400, Inf)
grps <- c('<=100', '101-200', '201-300', '301-400', '>400')
wage$Wage_Group <- cut(wage$wage, breaks=brks, labels = grps, right = FALSE)
wage <- financial %>%
  filter(category == 'Wage') %>%
  group_by(participantId) %>%
  summarise(wage = mean(amount))
brks <- c(0, 100, 200, 300, 400, Inf)
grps <- c('<=100', '101-200', '201-300', '301-400', '>400')
wage$Wage_Group <- cut(wage$wage, breaks=brks, labels = grps, right = FALSE)
#glimpse(wage)

brks <- c(0, 100, 200, 300, 400, Inf)
grps <- c('<=100', '101-200', '201-300', '301-400', '>400')
wage$Wage_Group <- cut(wage$wage, breaks=brks, labels = grps, right = FALSE)
# unique(wage$Wage_Group)
paged_table(financial, options = list(rows.print = 15, cols.print = 5))

month_consum <- financial %>%
  filter(!category %in% c('RentAdjustment', 'Wage')) %>%
  group_by(year, month, category) %>%
  summarise(spend = sum(-amount))
#glimpse(month_consum)

p_consum <- financial %>%
  filter(!category %in% c('RentAdjustment', 'Wage')) %>%
  group_by(participantId, category) %>%
  summarise(spend = sum(-amount))
#glimpse(p_consum)

participant_finance <- merge(participant_data, wage,by=c("participantId"))
#glimpse(participant_finance)
```

```{r}
d <- highlight_key(wage)
p1 <- ggplot(data=d, aes(x=wage,fill=Wage_Group)) +
    geom_histogram(position="dodge", binwidth=density(wage$wage)$bw) +
  labs(y= 'No. People', x= 'Wage',
       title = "Fig1: Wage Distribution",
       subtitle = "Most people get 58 per month")
p2 <- ggplot(data=d, aes(x=wage)) +
    geom_histogram(position="dodge",aes(y = ..density..), binwidth=density(wage$wage)$bw) +
  labs(y= 'Density', x= 'Wage',
       title = "Fig1: Wage Distribution",
       subtitle = "Most people get 50 per month")

ggplotly(p1)
```

